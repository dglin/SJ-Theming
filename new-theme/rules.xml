<?xml version="1.0" encoding="UTF-8"?>
<rules
    xmlns="http://namespaces.plone.org/diazo"
    xmlns:css="http://namespaces.plone.org/diazo/css"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xi="http://www.w3.org/2001/XInclude">

    <!-- The default theme, used for standard Plone web pages -->
    <theme href="index.html" css:if-content="#visual-portal-wrapper" />
    <notheme if-path="@@manage-viewlets" />
    <notheme if="$ajax_load" />
    
    <xsl:template css:match=".photoAlbumFolder">
        <div class="photoAlbumVisual">
            <div class="photoAlbumShadow">
                <div class="photoAlbumFolder">
                    <xsl:copy-of select="@*" />
                    <xsl:apply-templates />
                </div>
            </div>
        </div>
    </xsl:template>

    <xsl:template match="input[contains(@class, 'searchButton')]">
        <div class="fa fa-search">
            <xsl:element name="input">
                <xsl:copy-of select="@*" />
                <xsl:apply-templates />
            </xsl:element>
        </div>
    </xsl:template> 

    <xsl:template css:match="#edit-bar">
        <div class="edit-wrapping">
            <div>
                <xsl:copy-of select="@*" />
                <xsl:apply-templates />
            </div>
        </div>
    </xsl:template>

    <xsl:template css:match="article.vevent">
        <article class="vevent" >
            <div class="vevent-wrap">
                <xsl:apply-templates />
            </div>
        </article>
    </xsl:template>

    <after css:theme-children=".slogan">
        <xsl:copy-of select="//div[contains(@id, 'portal-top')]//div[contains(@class, 'panel-') and (.//div[contains(@class, 'portletStaticText')] and (.//div[contains(@class, 'width-full')])) ]" /> 
    </after>

    <xsl:template match="//div[@id='portal-top']//div[contains(@class, 'panel-') and (.//div[contains(@class, 'portletStaticText')] and (.//div[contains(@class, 'width-full')]))  and not(following-sibling::div[contains(@class, 'visualClear')] )   ]">
    </xsl:template>

    <replace css:content=".event.summary.details">
        <table class="listing event">
            <tbody>
                <xsl:for-each css:select="dt">
                    <tr>
                     <th><xsl:value-of select="." /></th>
                     <td><xsl:copy-of select="./following-sibling::dd[1]" disable-output-escaping="yes" /></td>
                    </tr>
                </xsl:for-each>
            </tbody>
        </table>
    </replace>

    <replace css:theme=".portal-logo">
        <xsl:element name="a">
            <xsl:attribute name="class">portal-logo</xsl:attribute>
            <xsl:attribute name="href">
                <xsl:value-of select="//a[@id='portal-logo']/@href" />
            </xsl:attribute>
            <xsl:copy-of select="//a[@id='portal-logo']/img" />
        </xsl:element>
    </replace>

    <xsl:template match="//div[contains(@class, 'newsImageContainer')]/a">
        <a>
            <xsl:attribute name="href">
                <xsl:value-of select="./@href" />
            </xsl:attribute>
            <div>
                <xsl:attribute name="style">
                    background-image:url("<xsl:value-of select="./@href" />")
                </xsl:attribute>
            </div>
        </a>
    </xsl:template>

    <xsl:template match="//ul[@id='portal-globalnav']/@id">
        <xsl:attribute name="id">
            <xsl:text>theme-globalnav</xsl:text> 
        </xsl:attribute>
    </xsl:template>

    <xsl:template match="//div[contains(@id, 'viewlet-below-content-body')]//div[contains(@class, 'panel-horizontal') and (.//div[contains(@class, 'width-full')]//div[contains(@class, 'portletStaticText')]) ]">
    </xsl:template>

    <!-- Rules applying to a standard Plone web page -->
    
    <rules css:if-content="#visual-portal-wrapper">

        <!-- HTML -->

        <copy attributes="*" content='/html' theme='/html' />

        <!-- Header -->

        <drop css:theme="meta[http-equiv='Content-type']" />
        <drop css:content="meta[name='viewport']" />
        <before content="/html/head/meta" css:theme="meta[name='viewport']" />
        <before content="/html/head/base" theme="/html/head/title" />
        <replace theme='/html/head/title' content='/html/head/title' />
        <after css:content="head link:not([href*='ploneCustom'])" theme="/html/head/title" />
        <after content="/html/head/style | /html/head/script" theme="/html/head/title" />
        <after css:content="head link[href*='ploneCustom']" theme-children="/html/head" />

        <rules css:if-content="#portal-megamenu">
            <replace css:content="#portal-globalnav">
                <xsl:copy>
                    <xsl:copy-of select="attribute::*[not(name()='id')]" />
                    <xsl:attribute name="id">theme-globalnav</xsl:attribute>
                    <xsl:apply-templates />
                </xsl:copy>
            </replace>
            <replace  css:theme="#theme-globalnav" css:content="#portal-megamenu"/>
            <drop css:content="#portal-top .panels .panel-0" if-not-path="@@manage-panels" if-not="$home_page"/>
            <drop content="//div[@id='portal-megamenu']//div[not(contains(@class, 'panel-0')) and (contains(@class, 'panel-'))]" />
        </rules>
        <rules css:if-content="#globalnav-wrapper">
            <replace css:content="#globalnav-wrapper" css:theme="#theme-globalnav" />
            <after css:theme-children=".nav_center_block" css:content="#portal-globalnav-mobile"  />
        </rules>
        <rules if-not-content="//*[@id='globalnav-wrapper'] or //*[@id='portal-megamenu']">
            <replace css:content="#portal-globalnav" css:theme="#theme-globalnav" />
            <after css:theme-children=".nav_center_block" css:content="#portal-globalnav-mobile"  />
        </rules>
        <replace css:content="#lineageSelectionForm" css:theme="#lineageSelectionForm" />

        <!-- Body-->

        <merge attributes="dir class" css:content="body" css:theme="body" />

        <!-- Top -->

        <replace css:content="#portal-searchbox" css:theme="#portal-searchbox" />
        <after css:content="#portal-languageselector" css:theme="#portal-searchbox" />
<!-- 
        <replace  css:theme=".nav_center_block .portal-logo" css:content="#portal-logo"/>
 -->
        <replace css:content-children="#portal-logo" css:theme-children=".nav_center_block .portal-logo" />
        <replace css:content-children="#portal-logo" css:theme-children=".top-image .portal-logo" if-not="$logo_big!=''" />
        <merge attributes="href" css:content="#portal-logo" css:theme=".portal-logo" />



        <replace css:theme="#portal-personaltools-wrapper" css:content="#portal-personaltools-wrapper" />

        <replace content="//div[@id='portal-top']//div[contains(@class,'panels')] | //div[@id='portal-footer-wrapper']//div[contains(@class,'panels')]">
            <div>
                <xsl:choose>
                    <xsl:when test="div[contains(@class,'row')]//*[contains(concat(' ', normalize-space(@class), ' '), ' portletOWLCarousel ')]">
                        <xsl:attribute name="class"><xsl:value-of select="@class" /> panel-full-width</xsl:attribute>
                    </xsl:when>
                    <xsl:otherwise>
                        <xsl:attribute name="class"><xsl:value-of select="@class" /></xsl:attribute>
                    </xsl:otherwise>
                </xsl:choose>
                <div class="container">
                    <xsl:apply-templates />
                </div>
                <div class="visualClear" />
            </div>
        </replace>

        <after css:theme-children=".top-panels-wrap" css:content="#portal-top .panels" />
        <rules css:if-content="#nav" if-not-path="@@manage-panels" if-not="$home_page">
            <after css:theme-children="html head" > 
                <style>
                    #portal-top .panels .panel-0 {
                        display:none;
                        }
                </style>
            </after>
        </rules>
        <drop content="//ul[@id='nav']//div[contains(@class,'subs')]//div[not(contains(@class, 'panel-0')) and (contains(@class, 'panel-'))]" />

        <!-- Portlets -->

        <replace css:content="#portal-column-one" css:theme="#portal-column-one" />
        <replace css:content="#portal-column-two" css:theme="#portal-column-two" />
        <drop css:content=".portletTopLeft" />
        <drop css:content=".portletTopRight" />
        <drop css:content=".portletBottomLeft" />
        <drop css:content=".portletBottomRight" />

        <!-- Content -->

        <copy attributes="*" content="//div[@id='portal-column-content']" theme="//div[@id='portal-column-content']" />
        <replace css:content="#edit-bar" css:theme="#edit-bar" />
        <replace css:content="#viewlet-above-content" css:theme="#viewlet-above-content" />
        <replace css:content="#viewlet-below-content" css:theme="#viewlet-below-content" />
        <replace css:content="#portal-column-content .portalMessage" css:theme="#portal-column-content .portalMessage" />
        <after css:theme="#edit-bar" css:content=".documentContent" />
        <replace content="//div[@id='content']/*[not(contains(@id, 'viewlet-above-content-body')) and not(contains(@id, 'viewlet-below-content-body')) ]" theme-children="//div[@id='content']" />

        <replace content="//div[@id='viewlet-below-content-body']/div[contains(@class,'panels')]/div[contains(concat(' ', normalize-space(@class), ' '), ' panel ')] | //div[@id='viewlet-above-content-body']/div[contains(@class,'panels')]/div[contains(concat(' ', normalize-space(@class), ' '), ' panel ')]">
            <div>
                <xsl:choose>
                    <xsl:when test="div[contains(@class,'row')]//*[contains(concat(' ', normalize-space(@class), ' '), ' portletOWLCarousel ')]">
                        <xsl:attribute name="class"><xsl:value-of select="@class" /> panel-full-width</xsl:attribute>
                    </xsl:when>
                    <xsl:otherwise>
                        <xsl:attribute name="class"><xsl:value-of select="@class" /></xsl:attribute>
                    </xsl:otherwise>
                </xsl:choose>
                <div class="container">
                    <xsl:apply-templates />
                </div>
                <div class="visualClear" />
            </div>
        </replace>

        <after css:theme="#portal-top" css:if-content="#viewlet-above-content-body .panels .portletWrapper, #viewlet-above-content-body .panels dl.collapsible, #viewlet-above-content-body .panels dl.manage-panel">
            <div class="panel-above-content panel-list">
                <xsl:apply-templates select="//div[@id='viewlet-above-content-body']//div[contains(concat(' ', normalize-space(@class), ' '), ' panels ')]" />
            </div>
        </after>
        <after css:theme=".main-section" css:if-content="#viewlet-below-content-body .panels .portletWrapper, #viewlet-below-content-body .panels dl.collapsible, #viewlet-below-content-body .panels dl.manage-panel">
            <div class="panel-below-content panel-list">
                <div id="panelBelowBG">
                    <div></div>
                </div>
                <xsl:apply-templates select="//div[@id='viewlet-below-content-body']//div[contains(concat(' ', normalize-space(@class), ' '), ' panels ')]" />
            </div>
        </after>

        <rules if-path="@@language-controlpanel">
            <after css:theme-children="html head" > 
                <style>
                    #content:not(.documentContent) {
                        display: none;
                        }   
                </style>
            </after>
        </rules>

        <rules if-content="//div[@id='portal-column-one'] or //div[@id='portal-column-two']">
            <after css:theme-children="html head" > 
                <style>
                #portal-columns {
                    max-width: 960px;
                    margin: 0 auto;
                    position: relative;
                    }
                #content-core .listing.event,
                #portal-column-content {
                    width:66% !important;
                    }   
                #portal-column-one.width-1\3a 4,
                #portal-column-two.width-1\3a 4  {
                    width: 31.666667%;
                    }
                #portal-column-two.position-3\3a 4 {
                    margin-left: -31.666667%;
                    }
                #portal-column-content.position-1\3a 4 {
                    margin-left: -66%;
                    }
                #content div.newsImageContainer {
                    width: 48.75%;
                    }
                @media only screen and (max-width: 767px) {    
                    #content div.newsImageContainer {
                        width: 100%;
                        }                    
                    }
                </style>
            </after>
        </rules>
        <rules if-content="//div[@id='portal-column-one'] and //div[@id='portal-column-two']">
            <after css:theme-children="html head" > 
                <style>
                #portal-column-one.width-1\3a 4,
                #portal-column-two.width-1\3a 4  {
                    width: 23.125%;
                    }
                #portal-column-two.position-3\3a 4 {
                    margin-left: -23.125%;
                    }
                #portal-column-content.position-1\3a 4 {
                    margin-left: -74.375%;
                    }
                </style>
            </after>
        </rules>
        <rules if-content="//div[@id='portal-column-one'] and //div[@id='portal-column-two']">
            <after css:theme-children="html head" > 
                <style>
                #portal-column-content.position-0.width-3\3a 4, 
                #portal-column-content.position-1\3a 4,
                #content .pullquote,
                #content div.newsImageContainer {
                    width: 48.75% !important;
                    }
                @media only screen and (max-width: 767px) {   
                    #portal-column-two {
                        padding:8px 0 0;
                        }
                    #content div.newsImageContainer {
                        width: 100% !important;
                        }
                    }
                </style>
            </after>
        </rules>
       <rules if-content="//div[@class='event_listing']" if-not-content="//div[@id='portal-column-one'] or //div[@id='portal-column-two']">
            <after css:theme-children="html head" > 
                <style>
                #content,
                .event_listing {
                    max-width: 100%;
                    margin: 0 auto;
                    position: relative;
                    }
                #viewlet-below-content-title,
                .documentFirstHeading,
                article .vevent-wrap,
                .event_listing header nav,
                #content > h2  {
                    max-width:960px;
                    margin: 0 auto;
                    position: relative;
                    }
                </style>
            </after>
        </rules>
       <rules if-content="//div[@class='event_listing']" >
            <after css:theme-children="html head" > 
                <style>
                @media only screen and (max-width: 1024px) { 
                .event_listing header, .vevent-wrap, 
                .documentFirstHeading, #portal-breadcrumbs {
                    padding: 0 15px;
                    -webkit-box-sizing: border-box;
                    -moz-box-sizing: border-box;
                    box-sizing: border-box;
                    }  
                #portal-columns {
                    padding: 0;
                    }
                    }
                </style>
            </after>
        </rules>

        <!--  Footer -->

        <replace css:content="#portal-footer-wrapper .panels" css:theme="#portal-footer-wrapper .panels" />
        <replace css:content="#portal-footer-wrapper #portal-footer" css:theme="#portal-footer-wrapper #portal-footer" />
        <replace css:content="#portal-colophon" css:theme="#portal-colophon" />
        <replace css:content="#portal-siteactions" css:theme="#portal-siteactions" />
        <replace css:content=".manage-panels-link" css:theme=".manage-panels-link" />
        <replace css:theme="#portal-footer-wrapper .cell > script" css:content="#portal-footer-wrapper .cell > script" />

    </rules>
    <xi:include href="tune.xml" />
</rules>